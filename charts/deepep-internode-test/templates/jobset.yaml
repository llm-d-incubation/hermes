{{- /*
JobSet-based DeepEP internode test - replaces separate master-job.yaml and worker-jobs.yaml
Uses JobSet for coordinated multi-node distributed training with built-in DNS and startup ordering
*/ -}}
apiVersion: jobset.x-k8s.io/v1alpha2
kind: JobSet
metadata:
  name: deepep-internode-{{ .Values.testId }}
  namespace: {{ .Values.namespace }}
  labels:
    app: deepep-internode-test
    test-id: {{ .Values.testId | quote }}
  {{- if .Values.exclusivePlacement }}
  annotations:
    alpha.jobset.sigs.k8s.io/exclusive-topology: {{ .Values.exclusivePlacement.topologyKey | default "kubernetes.io/hostname" }}
  {{- end }}
spec:
  # auto-cleanup after completion
  ttlSecondsAfterFinished: {{ .Values.ttlSecondsAfterFinished | default 300 }}

  # enable DNS hostnames for pod discovery
  # pods addressable as: deepep-internode-<testId>-<replicatedJob>-<jobIndex>-<podIndex>.deepep-internode-<testId>
  network:
    enableDNSHostnames: true
    publishNotReadyAddresses: true

  # designate master-0-0 as the coordinator pod
  coordinator:
    replicatedJob: master
    jobIndex: 0
    podIndex: 0

  # failure policy - fail fast on any job failure
  failurePolicy:
    maxRestarts: 0

  # success requires all jobs to complete
  successPolicy:
    operator: All

  replicatedJobs:
  # master (rank 0) - runs first, coordinates distributed training
  - name: master
    replicas: 1
    template:
      metadata:
        labels:
          app: deepep-internode-test
          role: master
          test-id: {{ .Values.testId | quote }}
      spec:
        activeDeadlineSeconds: {{ .Values.activeDeadlineSeconds }}
        backoffLimit: 0
        completions: 1
        parallelism: 1
        template:
          metadata:
            labels:
              app: deepep-internode-test
              role: master
              test-id: {{ .Values.testId | quote }}
            {{- if .Values.sriov.enabled }}
            annotations:
              k8s.v1.cni.cncf.io/networks: |
                [
                  {{- range $idx, $network := .Values.sriov.networks }}
                  {{- if $idx }},{{ end }}
                  {
                    "name": {{ $network.name | quote }},
                    "interface": {{ printf "net%d" (add1 $idx) | quote }}
                  }
                  {{- end }}
                ]
            {{- end }}
          spec:
            restartPolicy: Never
            {{- if .Values.imagePullSecrets }}
            imagePullSecrets:
            {{- range .Values.imagePullSecrets }}
            - name: {{ . }}
            {{- end }}
            {{- end }}
            nodeSelector:
              kubernetes.io/hostname: {{ index .Values.topology.nodes 0 "name" | quote }}
            containers:
            - name: deepep-internode-master
              image: {{ .Values.image }}
              command: ["/bin/bash", "/opt/deepep-test/master-entrypoint.sh"]
              resources:
                requests:
                  {{ .Values.resources.rdma }}: {{ .Values.resources.rdmaQuantity | quote }}
                  {{ .Values.resources.gpu }}: {{ .Values.resources.gpuCount | quote }}
                  memory: {{ .Values.resources.requests.memory }}
                  cpu: {{ .Values.resources.requests.cpu | quote }}
                limits:
                  {{ .Values.resources.rdma }}: {{ .Values.resources.rdmaQuantity | quote }}
                  {{ .Values.resources.gpu }}: {{ .Values.resources.gpuCount | quote }}
                  memory: {{ .Values.resources.limits.memory }}
                  cpu: {{ .Values.resources.limits.cpu | quote }}
              env:
              - name: TEST_ID
                value: {{ .Values.testId | quote }}
              - name: GPU_COUNT
                value: {{ .Values.resources.gpuCount | quote }}
              - name: WORLD_SIZE
                value: {{ .Values.deepep.worldSize | quote }}
              - name: RANK
                value: "0"
              - name: NUM_TOKENS
                value: {{ .Values.deepep.numTokens | quote }}
              - name: HIDDEN
                value: {{ .Values.deepep.hidden | quote }}
              - name: NUM_TOPK
                value: {{ .Values.deepep.numTopk | quote }}
              - name: NUM_EXPERTS
                value: {{ .Values.deepep.numExperts | quote }}
              - name: UCX_TLS
                value: {{ .Values.ucx.transports | quote }}
              {{- if .Values.ucx.gidIndex }}
              - name: UCX_IB_GID_INDEX
                value: {{ .Values.ucx.gidIndex | quote }}
              {{- end }}
              - name: UCX_LOG_LEVEL
                value: {{ .Values.ucx.logLevel | quote }}
              - name: UCX_ERROR_SIGNALS
                value: ""
              - name: POD_NAME
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.name
              - name: NODE_NAME
                valueFrom:
                  fieldRef:
                    fieldPath: spec.nodeName
              - name: POD_IP
                valueFrom:
                  fieldRef:
                    fieldPath: status.podIP
              # jobset index env vars (automatically injected)
              - name: JOB_COMPLETION_INDEX
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.annotations['batch.kubernetes.io/job-completion-index']
              volumeMounts:
              - name: deepep-test-script
                mountPath: /opt/deepep-test
                readOnly: true
              - name: dshm
                mountPath: /dev/shm
            volumes:
            - name: deepep-test-script
              configMap:
                name: deepep-internode-script-{{ .Values.testId }}
                defaultMode: 493
            - name: dshm
              emptyDir:
                medium: Memory
                sizeLimit: 16Gi

{{- range $idx, $node := .Values.topology.nodes }}
{{- if ne (int $node.rank) 0 }}
  # worker (rank {{ $node.rank }}) - waits for master to be ready, then joins distributed training
  - name: worker-{{ $node.rank }}
    replicas: 1
    # wait for master to be ready before starting
    dependsOn:
    - name: master
      status: Ready
    template:
      metadata:
        labels:
          app: deepep-internode-test
          role: worker
          rank: {{ $node.rank | quote }}
          test-id: {{ $.Values.testId | quote }}
      spec:
        activeDeadlineSeconds: {{ $.Values.activeDeadlineSeconds }}
        backoffLimit: 0
        completions: 1
        parallelism: 1
        template:
          metadata:
            labels:
              app: deepep-internode-test
              role: worker
              rank: {{ $node.rank | quote }}
              test-id: {{ $.Values.testId | quote }}
            {{- if $.Values.sriov.enabled }}
            annotations:
              k8s.v1.cni.cncf.io/networks: |
                [
                  {{- range $netIdx, $network := $.Values.sriov.networks }}
                  {{- if $netIdx }},{{ end }}
                  {
                    "name": {{ $network.name | quote }},
                    "interface": {{ printf "net%d" (add1 $netIdx) | quote }}
                  }
                  {{- end }}
                ]
            {{- end }}
          spec:
            restartPolicy: Never
            {{- if $.Values.imagePullSecrets }}
            imagePullSecrets:
            {{- range $.Values.imagePullSecrets }}
            - name: {{ . }}
            {{- end }}
            {{- end }}
            nodeSelector:
              kubernetes.io/hostname: {{ $node.name | quote }}
            containers:
            - name: deepep-internode-worker
              image: {{ $.Values.image }}
              command: ["/bin/bash", "/opt/deepep-test/worker-entrypoint.sh"]
              resources:
                requests:
                  {{ $.Values.resources.rdma }}: {{ $.Values.resources.rdmaQuantity | quote }}
                  {{ $.Values.resources.gpu }}: {{ $.Values.resources.gpuCount | quote }}
                  memory: {{ $.Values.resources.requests.memory }}
                  cpu: {{ $.Values.resources.requests.cpu | quote }}
                limits:
                  {{ $.Values.resources.rdma }}: {{ $.Values.resources.rdmaQuantity | quote }}
                  {{ $.Values.resources.gpu }}: {{ $.Values.resources.gpuCount | quote }}
                  memory: {{ $.Values.resources.limits.memory }}
                  cpu: {{ $.Values.resources.limits.cpu | quote }}
              env:
              - name: TEST_ID
                value: {{ $.Values.testId | quote }}
              - name: GPU_COUNT
                value: {{ $.Values.resources.gpuCount | quote }}
              - name: WORLD_SIZE
                value: {{ $.Values.deepep.worldSize | quote }}
              - name: RANK
                value: {{ $node.rank | quote }}
              - name: NUM_TOKENS
                value: {{ $.Values.deepep.numTokens | quote }}
              - name: HIDDEN
                value: {{ $.Values.deepep.hidden | quote }}
              - name: NUM_TOPK
                value: {{ $.Values.deepep.numTopk | quote }}
              - name: NUM_EXPERTS
                value: {{ $.Values.deepep.numExperts | quote }}
              - name: UCX_TLS
                value: {{ $.Values.ucx.transports | quote }}
              {{- if $.Values.ucx.gidIndex }}
              - name: UCX_IB_GID_INDEX
                value: {{ $.Values.ucx.gidIndex | quote }}
              {{- end }}
              - name: UCX_LOG_LEVEL
                value: {{ $.Values.ucx.logLevel | quote }}
              - name: UCX_ERROR_SIGNALS
                value: ""
              # use JobSet DNS for master discovery instead of separate Service
              # format: <jobset-name>-<replicatedJob>-<jobIndex>-<podIndex>.<jobset-name>
              - name: MASTER_ADDR
                value: deepep-internode-{{ $.Values.testId }}-master-0-0.deepep-internode-{{ $.Values.testId }}
              - name: MASTER_PORT
                value: {{ $.Values.deepep.rendezvous.masterPort | quote }}
              - name: POD_NAME
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.name
              - name: NODE_NAME
                valueFrom:
                  fieldRef:
                    fieldPath: spec.nodeName
              - name: POD_IP
                valueFrom:
                  fieldRef:
                    fieldPath: status.podIP
              # jobset index env vars
              - name: JOB_COMPLETION_INDEX
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.annotations['batch.kubernetes.io/job-completion-index']
              volumeMounts:
              - name: deepep-test-script
                mountPath: /opt/deepep-test
                readOnly: true
              - name: dshm
                mountPath: /dev/shm
            volumes:
            - name: deepep-test-script
              configMap:
                name: deepep-internode-script-{{ $.Values.testId }}
                defaultMode: 493
            - name: dshm
              emptyDir:
                medium: Memory
                sizeLimit: 16Gi
{{- end }}
{{- end }}
