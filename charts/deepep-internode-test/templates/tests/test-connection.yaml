apiVersion: v1
kind: Pod
metadata:
  name: {{ .Release.Name }}-test-connection
  namespace: {{ .Values.namespace }}
  labels:
    app: deepep-internode-test
    test-id: {{ .Values.testId | quote }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": hook-succeeded,hook-failed
spec:
  restartPolicy: Never
  containers:
  - name: test
    image: {{ .Values.image }}
    command: ["/bin/bash", "-c"]
    args:
    - |
      set -e
      echo "Testing DeepEP internode test resources..."

      echo "Checking JobSet DNS..."
      if getent hosts deepep-internode-{{ .Values.testId }}-master-0-0.deepep-internode-{{ .Values.testId }}; then
        echo "✓ Master pod is resolvable via JobSet DNS"
      else
        echo "✗ Master pod is NOT resolvable via JobSet DNS"
        exit 1
      fi

      echo "Checking ConfigMap..."
      if [ -f /opt/deepep-test/master-entrypoint.sh ]; then
        echo "✓ Master entrypoint script exists"
      else
        echo "✗ Master entrypoint script NOT found"
        exit 1
      fi

      if [ -f /opt/deepep-test/worker-entrypoint.sh ]; then
        echo "✓ Worker entrypoint script exists"
      else
        echo "✗ Worker entrypoint script NOT found"
        exit 1
      fi

      if [ -f /opt/deepep-test/test.py ]; then
        echo "✓ Test Python script exists"
      else
        echo "✗ Test Python script NOT found"
        exit 1
      fi

      if [ -f /opt/deepep-test/diagnostics.sh ]; then
        echo "✓ Diagnostics script exists"
      else
        echo "✗ Diagnostics script NOT found"
        exit 1
      fi

      echo "All connectivity tests passed!"
    volumeMounts:
    - name: deepep-test-script
      mountPath: /opt/deepep-test
      readOnly: true
  volumes:
  - name: deepep-test-script
    configMap:
      name: deepep-internode-script-{{ .Values.testId }}
      defaultMode: 493
