{{- /*
JobSet-based DeepGemm simple test - replaces separate node1-job.yaml and node2-job.yaml
Uses JobSet for coordinated multi-node GPU workloads with built-in DNS
*/ -}}
apiVersion: jobset.x-k8s.io/v1alpha2
kind: JobSet
metadata:
  name: deepgemm-simple-test-{{ .Values.testId }}
  namespace: {{ .Values.namespace }}
  labels:
    app: deepgemm-simple-test
    test-id: {{ .Values.testId | quote }}
    hermes.llm-d.io/workload: deepgemm-simple-test
    hermes.llm-d.io/platform: {{ .Values.topology.platform | quote }}
spec:
  # auto-cleanup after completion
  ttlSecondsAfterFinished: {{ .Values.ttlSecondsAfterFinished | default 300 }}

  # enable DNS hostnames for pod discovery
  network:
    enableDNSHostnames: true
    publishNotReadyAddresses: true

  # failure policy - fail fast on any job failure
  failurePolicy:
    maxRestarts: 0

  # success requires all jobs to complete
  successPolicy:
    operator: All

  replicatedJobs:
  # node1 - first GPU test node
  - name: node1
    replicas: 1
    template:
      metadata:
        labels:
          app: deepgemm-simple-test
          role: node1
          test-id: {{ .Values.testId | quote }}
          hermes.llm-d.io/workload: deepgemm-simple-test
      spec:
        activeDeadlineSeconds: {{ .Values.activeDeadlineSeconds }}
        backoffLimit: 0
        completions: 1
        parallelism: 1
        template:
          metadata:
            labels:
              app: deepgemm-simple-test
              role: node1
              test-id: {{ .Values.testId | quote }}
              hermes.llm-d.io/workload: deepgemm-simple-test
          spec:
            restartPolicy: Never
            nodeSelector:
              kubernetes.io/hostname: {{ index .Values.topology.nodes 0 "name" | quote }}
            containers:
            - name: deepgemm-simple-node1
              image: {{ .Values.image }}
              command: ["/bin/bash", "/opt/deepgemm-test/node1-entrypoint.sh"]
              resources:
                requests:
                  {{ .Values.resources.gpu }}: "1"
                  memory: {{ .Values.resources.requests.memory }}
                  cpu: {{ .Values.resources.requests.cpu | quote }}
                limits:
                  {{ .Values.resources.gpu }}: "1"
                  memory: {{ .Values.resources.limits.memory }}
                  cpu: {{ .Values.resources.limits.cpu | quote }}
              env:
              - name: NODE_NAME
                valueFrom:
                  fieldRef:
                    fieldPath: spec.nodeName
              - name: POD_NAME
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.name
              - name: POD_NAMESPACE
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.namespace
              - name: POD_IP
                valueFrom:
                  fieldRef:
                    fieldPath: status.podIP
              volumeMounts:
              - name: deepgemm-test-script
                mountPath: /opt/deepgemm-test
                readOnly: true
            volumes:
            - name: deepgemm-test-script
              configMap:
                name: deepgemm-simple-test-script-{{ .Values.testId }}
                defaultMode: 0755

  # node2 - second GPU test node
  - name: node2
    replicas: 1
    template:
      metadata:
        labels:
          app: deepgemm-simple-test
          role: node2
          test-id: {{ .Values.testId | quote }}
          hermes.llm-d.io/workload: deepgemm-simple-test
      spec:
        activeDeadlineSeconds: {{ .Values.activeDeadlineSeconds }}
        backoffLimit: 0
        completions: 1
        parallelism: 1
        template:
          metadata:
            labels:
              app: deepgemm-simple-test
              role: node2
              test-id: {{ .Values.testId | quote }}
              hermes.llm-d.io/workload: deepgemm-simple-test
          spec:
            restartPolicy: Never
            nodeSelector:
              kubernetes.io/hostname: {{ index .Values.topology.nodes 1 "name" | quote }}
            containers:
            - name: deepgemm-simple-node2
              image: {{ .Values.image }}
              command: ["/bin/bash", "/opt/deepgemm-test/node2-entrypoint.sh"]
              resources:
                requests:
                  {{ .Values.resources.gpu }}: "1"
                  memory: {{ .Values.resources.requests.memory }}
                  cpu: {{ .Values.resources.requests.cpu | quote }}
                limits:
                  {{ .Values.resources.gpu }}: "1"
                  memory: {{ .Values.resources.limits.memory }}
                  cpu: {{ .Values.resources.limits.cpu | quote }}
              env:
              - name: NODE_NAME
                valueFrom:
                  fieldRef:
                    fieldPath: spec.nodeName
              - name: POD_NAME
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.name
              - name: POD_NAMESPACE
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.namespace
              - name: POD_IP
                valueFrom:
                  fieldRef:
                    fieldPath: status.podIP
              volumeMounts:
              - name: deepgemm-test-script
                mountPath: /opt/deepgemm-test
                readOnly: true
            volumes:
            - name: deepgemm-test-script
              configMap:
                name: deepgemm-simple-test-script-{{ .Values.testId }}
                defaultMode: 0755
