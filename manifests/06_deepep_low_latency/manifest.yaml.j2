{%- from "_common/labels.yaml.j2" import job_labels, service_labels, pod_labels -%}
{%- from "_common/pod_metadata_env.yaml.j2" import pod_metadata_env -%}
{%- from "_common/resources.yaml.j2" import resources -%}
{%- from "_common/sriov.yaml.j2" import sriov_annotation_with_interface -%}
{%- from "_common/configmap.yaml.j2" import configmap -%}
{%- from "_common/ucx_env.yaml.j2" import ucx_env -%}
{%- from "_common/volumes.yaml.j2" import configmap_volume_source, dshm_volume, dshm_mount -%}
---
{{- configmap("deepep-lowlatency-script", "deepep-lowlatency-test", configmap_files) }}
---
apiVersion: v1
kind: Service
metadata:
  name: deepep-lowlatency-master-{{ test_id }}
  labels:
{{- service_labels("deepep-lowlatency-test", "master") }}
spec:
  clusterIP: None
  selector:
    app: deepep-lowlatency-test
    role: master
    test-id: "{{ test_id }}"
  ports:
  - port: 29500
    name: dist
---
apiVersion: batch/v1
kind: Job
metadata:
  name: deepep-lowlatency-master-{{ test_id }}
  labels:
{{- job_labels("deepep-lowlatency-test", "master") }}
spec:
  template:
    metadata:
      labels:
{{- pod_labels("deepep-lowlatency-test", "master") }}
{{- sriov_annotation_with_interface() }}
    spec:
      restartPolicy: Never
      nodeSelector:
        kubernetes.io/hostname: "{{ server_node.name }}"
      containers:
      - name: deepep-lowlatency-master
        image: {{ image }}
        command: ["/bin/bash", "/opt/deepep-test/master-entrypoint.sh"]
{{- resources(rdma_qty="1", gpu_qty=gpu_count, memory_req="8Gi", memory_lim="16Gi", cpu_req="4", cpu_lim="8") }}
        env:
        - name: TEST_ID
          value: "{{ test_id }}"
{{- pod_metadata_env() }}
{{- ucx_env(log_level="info") }}
        - name: SRIOV_INTERFACE
          value: "{{ sriov_interface }}"
        - name: NCCL_SOCKET_IFNAME
          value: "{{ sriov_interface }}"
        - name: NCCL_DEBUG
          value: "INFO"
        volumeMounts:
        - name: deepep-test-script
          mountPath: /opt/deepep-test
          readOnly: true
{{- dshm_mount() }}
      volumes:
{{- configmap_volume_source("deepep-test-script", "deepep-lowlatency-script") }}
{{- dshm_volume(16) }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: deepep-lowlatency-worker-{{ test_id }}
  labels:
{{- job_labels("deepep-lowlatency-test", "worker") }}
spec:
  template:
    metadata:
      labels:
{{- pod_labels("deepep-lowlatency-test", "worker") }}
{{- sriov_annotation_with_interface() }}
    spec:
      restartPolicy: Never
      nodeSelector:
        kubernetes.io/hostname: "{{ client_node.name }}"
      containers:
      - name: deepep-lowlatency-worker
        image: {{ image }}
        command: ["/bin/bash", "/opt/deepep-test/worker-entrypoint.sh"]
{{- resources(rdma_qty="1", gpu_qty=gpu_count, memory_req="8Gi", memory_lim="16Gi", cpu_req="4", cpu_lim="8") }}
        env:
        - name: TEST_ID
          value: "{{ test_id }}"
{{- pod_metadata_env() }}
{{- ucx_env(log_level="info") }}
        - name: SRIOV_INTERFACE
          value: "{{ sriov_interface }}"
        - name: NCCL_SOCKET_IFNAME
          value: "{{ sriov_interface }}"
        - name: NCCL_DEBUG
          value: "INFO"
        volumeMounts:
        - name: deepep-test-script
          mountPath: /opt/deepep-test
          readOnly: true
{{- dshm_mount() }}
      volumes:
{{- configmap_volume_source("deepep-test-script", "deepep-lowlatency-script") }}
{{- dshm_volume(16) }}
