{%- from "_common/labels.yaml.j2" import job_labels, service_labels, pod_labels -%}
{%- from "_common/pod_metadata_env.yaml.j2" import pod_metadata_env -%}
{%- from "_common/resources.yaml.j2" import resources -%}
{%- from "_common/ucx_env.yaml.j2" import ucx_env -%}
{%- from "_common/sriov.yaml.j2" import sriov_annotation_simple -%}
{%- from "_common/configmap.yaml.j2" import configmap -%}
{%- from "_common/volumes.yaml.j2" import configmap_volume_source, dshm_volume, dshm_mount -%}
---
{{- configmap("nixl-test-script", "nixl-transfer-test", configmap_files) }}
---
apiVersion: v1
kind: Service
metadata:
  name: nixl-test-target
  labels:
{{- service_labels("nixl-transfer-test", "target") }}
spec:
  clusterIP: None  # headless service
  selector:
    app: nixl-transfer-test
    role: target
    test-id: "{{ test_id }}"
  ports:
  - name: nixl-transfer
    port: 18515
    targetPort: 18515
    protocol: TCP
---
apiVersion: batch/v1
kind: Job
metadata:
  name: nixl-test-target-{{ test_id }}
  labels:
{{- job_labels("nixl-transfer-test", "target") }}
spec:
  template:
    metadata:
      labels:
{{- pod_labels("nixl-transfer-test", "target") }}
{{- sriov_annotation_simple() }}
    spec:
      restartPolicy: Never
      nodeSelector:
        kubernetes.io/hostname: "{{ server_node.name }}"
      containers:
      - name: nixl-target
        image: {{ image }}
        command: ["/bin/bash", "/opt/nixl-test/target-entrypoint.sh"]
{{- resources(rdma_qty="1", gpu_qty="1" if request_gpu else None, memory_req="2Gi", memory_lim="4Gi", cpu_req="1", cpu_lim="2") }}
        env:
{{- ucx_env(log_level="info") }}
{{- pod_metadata_env() }}
        - name: RDMA_DEVICE
          value: "{{ server_node.rdma_device }}"
        volumeMounts:
        - name: nixl-test-script
          mountPath: /opt/nixl-test
          readOnly: true
{{- dshm_mount() }}
      volumes:
{{- configmap_volume_source("nixl-test-script", "nixl-test-script") }}
{{- dshm_volume(4) }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: nixl-test-initiator-{{ test_id }}
  labels:
{{- job_labels("nixl-transfer-test", "initiator") }}
spec:
  template:
    metadata:
      labels:
{{- pod_labels("nixl-transfer-test", "initiator") }}
{{- sriov_annotation_simple() }}
    spec:
      restartPolicy: Never
      nodeSelector:
        kubernetes.io/hostname: "{{ client_node.name }}"
      containers:
      - name: nixl-initiator
        image: {{ image }}
        command: ["/bin/bash", "/opt/nixl-test/initiator-entrypoint.sh"]
{{- resources(rdma_qty="1", gpu_qty="1" if request_gpu else None, memory_req="2Gi", memory_lim="4Gi", cpu_req="1", cpu_lim="2") }}
        env:
{{- ucx_env(log_level="debug") }}
        - name: TARGET_HOST
          value: "{{ server_ip }}"
        - name: TARGET_PORT
          value: "18515"
{{- pod_metadata_env() }}
        - name: RDMA_DEVICE
          value: "{{ client_node.rdma_device }}"
        volumeMounts:
        - name: nixl-test-script
          mountPath: /opt/nixl-test
          readOnly: true
{{- dshm_mount() }}
      volumes:
{{- configmap_volume_source("nixl-test-script", "nixl-test-script") }}
{{- dshm_volume(4) }}
